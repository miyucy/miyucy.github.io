<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Camera</title>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: min(100vw, 1024px);
        margin: 0 auto;
        padding: 0;
      }
      .video-container {
        position: relative;
        margin-bottom: 20px;
      }
      #video {
        width: 100vw;
        object-fit: contain;
        background-color: #f0f0f0;
      }
      .controls {
        margin-top: 20px;
      }
      .error {
        color: red;
        margin: 10px 0;
        padding: 10px;
        background-color: #ffebee;
        border-radius: 4px;
        display: none;
      }
      select {
        padding: 8px 16px;
        margin: 5px;
        border-radius: 4px;
      }
      #deviceSelect {
        min-width: 200px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="video-container">
        <video id="video" autoplay playsinline muted></video>
      </div>
      <div class="error" id="error"></div>
      <div class="controls">
        <select id="deviceSelect"></select>
      </div>
    </div>

    <script>
      const video = document.getElementById("video");
      const error = document.getElementById("error");
      const deviceSelect = document.getElementById("deviceSelect");
      let stream = null;
      let imageCapture = null;
      let photoSettings = null;

      function showError(message) {
        error.textContent = message;
        error.style.display = "block";
      }

      function hideError() {
        error.style.display = "none";
      }

      function updateCapabilities() {
        if (!imageCapture) return;

        imageCapture.getPhotoCapabilities().then((capabilities) => {
          if (capabilities) {
            // 設定を保存
            photoSettings = {};
            if (capabilities.imageWidth?.max) {
              photoSettings.imageWidth = capabilities.imageWidth.max;
            }
            if (capabilities.imageHeight?.max) {
              photoSettings.imageHeight = capabilities.imageHeight.max;
            }
            if (
              capabilities.redEyeReduction == "always" ||
              capabilities.redEyeReduction == "controllable"
            ) {
              photoSettings.redEyeReduction = true;
            }
            if (
              capabilities.fillLightMode &&
              capabilities.fillLightMode.find((mode) => mode == "off")
            ) {
              photoSettings.fillLightMode = "off";
            }
          }
        });
      }

      async function updateDeviceList() {
        try {
          const tempStream = await navigator.mediaDevices.getUserMedia({
            video: true,
          });
          tempStream.getTracks().forEach((track) => track.stop());

          const devices = await navigator.mediaDevices.enumerateDevices();
          const videoDevices = devices.filter(
            (device) => device.kind === "videoinput",
          );

          deviceSelect.innerHTML = "";
          deviceSelect.value = "";
          hideError();

          if (!videoDevices.length) {
            return;
          }

          videoDevices.forEach((device) => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text =
              device.label || `カメラ ${videoDevices.indexOf(device) + 1}`;
            deviceSelect.appendChild(option);
          });

          videoDevices.forEach((device) => {
            if (device.label && device.label.includes("back")) {
              deviceSelect.value = device.deviceId;
            }
          });
          if (!deviceSelect.value) {
            deviceSelect.value = videoDevices[0].deviceId;
          }

          startCamera();
        } catch (err) {
          showError("カメラデバイスの列挙に失敗しました: " + err.message);
        }
      }

      async function startCamera() {
        if (stream) {
          stopCamera();
        }

        try {
          const constraints = {
            video: {
              deviceId: deviceSelect.value
                ? { exact: deviceSelect.value }
                : undefined,
            },
          };

          stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;

          // ImageCapture オブジェクトの作成
          const track = stream.getVideoTracks()[0];
          imageCapture = new ImageCapture(track);

          // カメラ性能の更新
          updateCapabilities();

          hideError();
        } catch (err) {
          showError("カメラの開始に失敗しました: " + err.message);
        }
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          video.srcObject = null;
          stream = null;
          imageCapture = null;
          photoSettings = null;
        }
      }

      function takePhoto() {
        if (!imageCapture) return;

        const filename = `photo-${new Date().toISOString()}.jpg`;
        let photoOptions = undefined;

        if (photoSettings) {
          photoOptions = {
            imageWidth: photoSettings.imageWidth,
            imageHeight: photoSettings.imageHeight,
            fillLightMode: photoSettings.fillLightMode,
            redEyeReduction: photoSettings.redEyeReduction,
          };
        }

        imageCapture
          .takePhoto(photoOptions)
          .then(blob => URL.createObjectURL(blob))
          .then(url => {
            const link = document.createElement("a");
            link.download = filename;
            link.href = url;
            link.click()
            return url
          }).then(url => URL.revokeObjectURL(url))
          .catch((err) => {
            console.error("Photo options:", photoSettings);
            showError("写真の撮影に失敗しました: " + err.message);
          });
      }

      video.addEventListener("click", takePhoto);
      deviceSelect.addEventListener("change", startCamera);
      navigator.mediaDevices.addEventListener("devicechange", updateDeviceList);
      updateDeviceList();
    </script>
  </body>
</html>
