<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <style>
     #camera { display: block; margin: auto; max-width: 100%; }
     #roll { display: flex; flex-direction: row-reverse; padding-left: 0; list-style: none; }
     #roll li { flex: 1 1 auto; }
     #roll img { display: block;  max-width: 100%; height: auto; }
     .hidden { display: none; }
    </style>
  </head>
  <body>
    <div>
      <div>
        <video id="camera" autoplay="autoplay"></video>
        <select id="selector" class="hidden"></select>
        <ul id="roll"></ul>
      </div>

      <div class="hidden">
        <canvas id="canvas"></canvas>
        <a id="anchor" target="_blank"></a>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var video = document.getElementById("camera");
        var canvas = document.getElementById("canvas");
        var anchor = document.getElementById("anchor");
        var roll = document.getElementById("roll");
        var selector = document.getElementById("selector");
        var dataURLs = [];
        var deviceIds = [];
        var curMediaStreamURL = null;
        var curMediaStream = null;

        function download(dataURL) {
          anchor.href = dataURL;
          anchor.download = "" + +(new Date()) + ".jpg";
          anchor.click();
        };

        function append(dataURL) {
          dataURLs.push(dataURL);
          if (dataURLs.length > 5) {
            dataURLs.shift();
          }
          refresh();
        }

        function refresh() {
          var i, n;
          var children = dataURLs.map(function (dataURL) {
            var li = document.createElement("li");
            var img = document.createElement("img");
            img.src = dataURL;
            li.appendChild(img);
            li.addEventListener("click", function (evt) {
              evt.preventDefault();
              download(dataURL);
            });
            return li;
          });

          while (roll.firstChild) {
            roll.removeChild(roll.firstChild);
          }

          n = children.length;
          for (i = 0; i < n; i++) {
            roll.appendChild(children[i]);
          }
        }

        function destroy() {
          if (curMediaStreamURL) {
            window.URL.revokeObjectURL(curMediaStreamURL);
            curMediaStreamURL = null;
          }

          if (curMediaStream) {
            (function (tracks) {
              for (var i=0, n=tracks.length; i<n; i++) {
                var track = tracks[i];
                track.stop();
              }
            })(curMediaStream.getTracks());
            curMediaStream = null;
          }
        }

        function create(mediaStream) {
          destroy();
          curMediaStream = mediaStream;
          curMediaStreamURL = window.URL.createObjectURL(curMediaStream);
          return curMediaStreamURL;
        }

        video.addEventListener("click", function (evt) {
          evt.preventDefault();
          var videoWidth = video.videoWidth;
          var videoHeight = video.videoHeight;
          canvas.width = videoWidth;
          canvas.height = videoHeight;
          canvas.getContext("2d").drawImage(video, 0, 0, videoWidth, videoHeight, 0, 0, videoWidth, videoHeight);
          append(canvas.toDataURL("image/jpeg"));
        });

        selector.addEventListener("change", function (evt) {
          navigator.getUserMedia({ video: { deviceId: { exact: selector.value } }, audio: false }, function (mediaStream) {
            video.src = create(mediaStream);
            video.play();
          }, console.error);
        });

        navigator.mediaDevices.enumerateDevices().then(function (devices) {
          devices.filter(function (device) {
            return device.kind === 'videoinput';
          }).forEach(function (device) {
            var option = document.createElement('option');
            option.value = device.deviceId;
            option.text = device.label;
            selector.appendChild(option);
          });

          if (selector.firstChild) {
            selector.firstChild.selected = true;
            selector.dispatchEvent(new Event('change'));
          }

          if (selector.children.length > 1) {
            selector.classList.remove('hidden');
          } else {
            selector.classList.add('hidden');
          }
        }).catch(console.error);
      });
    </script>
  </body>
</html>
